// ==UserScript==
// @name        kjj listing filter
// @namespace   kjj
// @description kjj create viewed listings
// @include     http://www.kijiji.ca/*
// @version     1
// @grant       none
// ==/UserScript==

/* Get/Set LocalStorage */
//1. Get current location and search term
var urlElementsArray = (window.location.href).split("/");

//2. Declare variables necessary for storage list creation
var searchArea = '';
var searchTerm = '';
var domainReached = false;
var domainPosition = 0;
var searchStorageListName ='';
var pageStorageListValues = [];

//3. Parse url to determine necessary parts for storage list
$.each(urlElementsArray, function(index, urlPart){
  if (domainReached){
    switch (index) {
      case (domainPosition + 1):
         searchArea = urlPart;
        break;
      case (domainPosition + 2):
         searchTerm = urlPart;
        break;
    }
  } else {
    if (urlPart == 'www.kijiji.ca' ) {
      domainReached = true;
      domainPosition = index;
    } 
    return;
  }
});


//4. Create list name 
if (searchArea != '' && searchTerm != '') {
  searchStorageListName = 'GM_'+searchArea+"_"+searchTerm;
  console.log('searchStorageListName: '+searchStorageListName);
}

//Try to retrieve list
var pageStorageList = JSON.parse(localStorage.getItem(searchStorageListName));//setTimeout(getLocalStorageList, 0);
console.log('%cTry to get list => '+searchStorageListName+' = '+pageStorageList,'color:yellow;');


//Crate new and save current page list to storage
if (pageStorageList == null) {
  localStorage.setItem(searchStorageListName, JSON.stringify(pageStorageListValues));//setTimeout(saveLocalStorageList, 0);
  console.log('%cSaved new list => '+searchStorageListName+' = '+pageStorageListValues, 'color:yellow;');
} else {
  pageStorageListValues = pageStorageList;
  
}





//Create and attach remove button
document.body.style.background = "#f1f1f1";//drop a hint GM is fine
//Hide clear ads
$('.search-item.third-party, .adsense-top-bar').hide();           //also available classes: cas-channel top-feature  


var itemList = $('.search-item.regular-ad');
var numberOfAds = $('.search-item.regular-ad').length;
var attachedBtns = false;
   


$.each(itemList, function(index, item){
  
  if ( $.inArray( $(item).data('ad-id'), pageStorageListValues)  != -1){
    $(item).hide();

  } else {
      $(item).prepend('<a class="js-hide-btn"  href="javascript:;" data-ad-id="'+$(item).data('ad-id')+'" style="z-index:9999;position:absolute;top:10px;left:10px;display:block;padding:10px;background:#04bbff;color:#fff;text-decoration:none;font-weight:600;box-shadow:3px 3px 2px #444;">Remove</a>');

  }
  

  
  
  
  
  
  //spot the list end
 if ((index + 1) == numberOfAds) {
      attachedBtns = true;
  }
});          






/*----------------------------------------------------------------------------------------------*/
/*Parse page and hide all ads from storage list*/
var parsePage = function(){
  console.log('%cParsing the page ','color:yellow');
  
}


/* 5. Save localStorage*/
var saveLocalStorageList = function(){
  console.log('%cSaving '+searchStorageListName +' - '+ pageStorageListValues,'color:orange');
  localStorage.setItem(searchStorageListName, JSON.stringify(pageStorageListValues));//setTimeout(saveLocalStorageList, 0);
}

/* 4. Get localStorage Items*/
var getLocalStorageList = function(){
   localStorage.getItem(pageStorageList);
}

/* 3. Hide element */
var jsHideEvent = function(){
  
  var adItem = $(this).closest('.search-item.regular-ad');
  $(adItem).hide();
  
  pageStorageListValues.push($(this).data('ad-id'));
  console.log('%cPageStorageListValues - '+pageStorageListValues, 'color:orange');

  localStorage.setItem(searchStorageListName, JSON.stringify(pageStorageListValues));//setTimeout(saveLocalStorageList, 0);

  
  //setTimeout(saveLocalStorageList, 0);
}

/* 2. Attach eventListener */
var setEventListeners = function(){
  
  if (attachedBtns) {
    console.log('%cAttaching event listener','color:yellow');
    
    var elmlinkList = document.getElementsByClassName('js-hide-btn');
    $.each(elmlinkList, function(index, elmlink){
       elmlink.addEventListener('click', jsHideEvent, true);
    });
        
  } else {
    console.log('%cNot all the btns attached, wait and check btns again', 'color:yellow');
    setTimeout(setEventListeners, 3000);
  }
}






        

/* 1. Trigger Event Attacher listening*/
setTimeout(setEventListeners, 0);





/*GET LOCAL STORAGE AND PARSE TO FIND OWN LISTS*/

/*$.each(window.localStorage, function(index, storageIitem){

 if ( storageIitem.substring( 0 , 2 ) === key){
  var data = window.localStorage.getItem( storageIitem ) );
  storageLists.push(storageIitem);
  console.log(storageLists);
 }
}
*/
